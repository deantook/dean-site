# 高质量的异步任务
在企业级系统中，无论系统的大小、规模、复杂度，大部分请求都是和响应都是同步的。但是往往也会存在异步任务，即在业务主流程完成后需要调用另外一个系统，这个过程往往会增加响应时间，对于这样的操作，则需要发起异步任务。

## 基于 Spring 开发高质量的异步任务

在 Spring 中，可以通过 Java 的线程池来原生支持异步任务的开发。在 Spring 中封装了一个 ThreadPoolTaskExecutor 类，在进行进程间的异步任务时就可以使用该类来操作。

### 配置异步线程池 Bean

```java
public class ContextCopyingDecorator implements TaskDecorator {
    @Override
    public Runnable decorate(Runnable runnable) {
        RequestAttributes context = RequestContextHolder.currentRequestAttributes();

        return () -> {
            try {
                RequestContextHolder.setRequestAttributes(context);
                runnable.run();
            } finally {
                RequestContextHolder.resetRequestAttributes();
            }
        };
    }
}
```

```java
@Configuration
@EnableAsync
public class AsyncConfig {
    public static final String ASYNC_EXECUTOR_NAME = "asyncExecutor";

    @Bean(name = ASYNC_EXECUTOR_NAME)
    public Executor asyncExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setTaskDecorator(new ContextCopyingDecorator());
        executor.setCorePoolSize(4);
        executor.setMaxPoolSize(8);
        executor.setQueueCapacity(100);
        executor.setWaitForTasksToCompleteOnShutdown(true);
        executor.setThreadNamePrefix("AsyncThread-");
        executor.initialize();
        return executor;
    }

}
```

```java
    @Async(AsyncConfig.ASYNC_EXECUTOR_NAME)
    public void sendSms(String userId) {
        try{
            //发送短信
        }catch (Exception e){
            String errMsg = "短信发送异常";
        }
    }
```

